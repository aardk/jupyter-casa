Bootstrap: docker
From: ubuntu:20.04
IncludeCmd: no

%runscript
    echo "Starting Jupyter"
    jupyter notebook

%environment
    export PYTHONPATH="/usr/local/lib/python3.8/dist-packages" 
    export QT_X11_NO_MITSHM=1
    unset XDG_RUNTIME_DIR 

%setup
    # Add jupyter-casa tree to container
    mkdir ${SINGULARITY_ROOTFS}/usr/local/jupyter-casa
    cp -r jupyter python ${SINGULARITY_ROOTFS}/usr/local/jupyter-casa

%post
    # CASA needs gfortran3 which is not in 20.04 repo; get this package from 18.04 first
    echo deb http://nl.archive.ubuntu.com/ubuntu/ bionic main universe >/etc/apt/sources.list
    apt-get update
    apt-get install -y g++-6
    update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-6 6
    apt-get install -y g++libgfortran3 libtinfo5

    # Setup enviroment
    echo deb http://nl.archive.ubuntu.com/ubuntu/ focal main restricted universe multiverse >/etc/apt/sources.list
    echo deb http://nl.archive.ubuntu.com/ubuntu/ focal-updates main restricted universe multiverse >>/etc/apt/sources.list

    export LC_ALL=C
    apt-get update && apt-get install -y apt-utils debconf-utils && apt-get upgrade -y
    apt-get install -y python3 python3-dev python3-pip wget
    apt-get install -y iproute2 lsof xvfb
    pip3 install -U pip
    /usr/local/bin/pip install matplotlib astropy jupyter ipywidgets #widgetsnbextension
    jupyter nbextension enable --py widgetsnbextension --sys-prefix
    # Install casa
    CASA_VERSION=6.1.2.7
    # Casatools is a python 3.6 wheel, but unbuntu 20.04 is 3.8; manually install the package
    apt-get install -y unzip
    cd /usr/local/lib/python3.8/dist-packages/
    wget https://casa-pip.nrao.edu/repository/casa-wheel/packages/casatools/${CASA_VERSION}/casatools-${CASA_VERSION}-cp36-cp36m-linux_x86_64.whl
    unzip -X casatools-${CASA_VERSION}-cp36-cp36m-linux_x86_64.whl
    rm -f casatools-${CASA_VERSION}-cp36-cp36m-linux_x86_64.whl
    #/usr/local/bin/pip install --extra-index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casatools==${CASA_VERSION}
    /usr/local/bin/pip install --extra-index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casatasks==${CASA_VERSION}
    /usr/local/bin/pip install --extra-index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casashell==${CASA_VERSION}
    #
    # Plotms and Casaviewer use appimage which from within singularity need 
    # root privaliges to mount due to SUID issues, as a work around we extract
    # the images and modify the casa tasks to call the extracted images
    /usr/local/bin/pip install --extra-index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casaplotms
    cd /usr/local/lib/python3.8/dist-packages/casaplotms/__bin__
    ./casaplotms-x86_64.AppImage --appimage-extract
    rm casaplotms-x86_64.AppImage
    find squashfs-root -type d | xargs chmod 775
    cd ..
    sed -i -e 's/casaplotms-x86_64.AppImage/squashfs-root\/AppRun/' private/plotmstool.py
    #
    /usr/local/bin/pip install --extra-index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casaviewer
    cd /usr/local/lib/python3.8/dist-packages/casaviewer/__bin__
    ./casaviewer-x86_64.AppImage --appimage-extract
    rm casaviewer-x86_64.AppImage
    find squashfs-root -type d | xargs chmod 775
    cd ..
    sed -i -e 's/casaviewer-x86_64.AppImage/squashfs-root\/AppRun/' private/config.py
    #
    #########################################
    # carta
    #########################################
    #
    cd /usr/local
    CARTAVERSION=1.4
    wget https://github.com/CARTAvis/carta/releases/download/v${CARTAVERSION}/CARTA-v${CARTAVERSION}-remote.tgz
    apt-get install -y libnss3 libgdk-pixbuf2.0-0 libgtk-3-0 #libx11-xcb1 libxss1 libasound2
    tar zxf CARTA-v${CARTAVERSION}-remote.tgz
    #
    #########################################
    # Install CASACORE
    #########################################
    #
    CASACORE_VERSION=3.4.0
    apt-get install -y libboost-all-dev build-essential libpython3-dev python3-dev python3-numpy gfortran \
                       flex bison libbison-dev libatlas-base-dev liblapack-dev libcfitsio-dev \
                       wcslib-dev cmake libreadline-dev libncurses5-dev libgsl-dev libfftw3-dev libhdf5-dev 
    cd /usr/local
    wget https://github.com/casacore/casacore/archive/v${CASACORE_VERSION}.tar.gz
    tar xvf v${CASACORE_VERSION}.tar.gz
    mkdir casacore-${CASACORE_VERSION}/build
    cd casacore-${CASACORE_VERSION}/build
    # This is the reverse PATH order than it would be during singularity build
    # Needed for casacore 3.4 to build on 20.04
    PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    cmake -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_BUILD_TYPE=Release -DBUILD_DEPRECATED=ON -DBUILD_PYTHON=OFF -DBUILD_PYTHON3=ON .. 
    make -j4
    make install
    cd ../..
    rm -rf v${CASACORE_VERSION}.tar.gz casacore-${CASACORE_VERSION}
    #
    #########################################
    # Add Wsclean
    #########################################
    #
    apt-get install -y git
    cd /usr/local
    git clone https://github.com/lofar-astron/LOFARBeam.git
    cd LOFARBeam
    # git checkout v4.1.1 # NB v4.1.1 release doesn't work on 20.04
    mkdir -p build
    cd build
    cmake -DPYTHON_EXECUTABLE=$(which python3) ..
    make -j4
    make install
    cd /usr/local
    rm -rf LOFARBeam
    git clone https://gitlab.com/aroffringa/wsclean.git wsclean-code
    cd wsclean-code
    git checkout v2.10.1
    mkdir build
    cd build
    cmake ..
    make -j4
    make install
    /usr/local/bin/pip install python-casacore
    cd /usr/local
    rm -rf wsclean-code
    #
    #########################################
    # Add AOFLAGGER
    #########################################
    #
    apt-get install -y libboost-test-dev libgtkmm-3.0-dev liblua5.3-dev libpng-dev libxml2-dev python3-pybind11
    /usr/local/bin/pip install pytest
    git clone https://gitlab.com/aroffringa/aoflagger.git
    mkdir -p aoflagger/build
    cd aoflagger/build
    cmake ..
    make -j4
    make install
    cd ../..
    rm -rf aoflagger
    #
    #########################################
    # JIVE VLBI Tools
    #########################################
    #
    git clone https://github.com/jive-vlbi/casa-vlbi 
    cp casa-vlbi/*py /usr/local/bin 
    cp -r casa-vlbi/casavlbitools /usr/local/lib/python3.8/dist-packages 
    rm -rf casa-vlbi
    #
    #########################################
    # Plotcalng
    #########################################
    #
    git clone https://github.com/aardk/casa-plot-tools
    cp casa-plot-tools/python/plotcalng.py /usr/local/lib/python3.8/dist-packages
    rm -rf casa-plot-tools
    #
    #########################################
    # Jupyter-casa
    #########################################
    #
    cd /usr/local
    mkdir -p /usr/local/lib/python3.8/dist-packages
    mv jupyter-casa/python/start_casa /usr/local/lib/python3.8/dist-packages/
    cp -r jupyter-casa/jupyter /usr/local/share/
