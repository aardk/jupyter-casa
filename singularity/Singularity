Bootstrap: docker
From: ubuntu:18.04
IncludeCmd: no

%runscript
    echo "Starting Jupyter"
    jupyter notebook

%environment
    export PYTHONPATH="/usr/local/lib/python3.6/dist-packages" 
    export QT_X11_NO_MITSHM=1
    unset XDG_RUNTIME_DIR 

%setup
    # Add jupyter-casa tree to container
    mkdir ${SINGULARITY_ROOTFS}/usr/local/jupyter-casa
    cp -r jupyter python ${SINGULARITY_ROOTFS}/usr/local/jupyter-casa

%post
    # Setup enviroment
    echo deb http://nl.archive.ubuntu.com/ubuntu/ bionic main restricted universe multiverse >/etc/apt/sources.list
    echo deb http://nl.archive.ubuntu.com/ubuntu/ bionic-updates main restricted universe multiverse >>/etc/apt/sources.list

    export LC_ALL=C
    apt-get update && apt-get install -y apt-utils debconf-utils && apt-get upgrade -y
    apt-get install -y python3 python3-dev python3-pip libgfortran3 wget
    apt-get install -y iproute2 lsof xvfb vim nano emacs-nox curl
    # Jupyterlab needs nodejs to build extensions
    curl -sL https://deb.nodesource.com/setup_14.x | bash -
    apt-get install -y nodejs

    pip3 install -U pip
    /usr/local/bin/pip install matplotlib astropy notebook widgetsnbextension ipywidgets jupyterhub jupyterlab
    jupyter nbextension enable --py widgetsnbextension --sys-prefix
    jupyter labextension install @jupyter-widgets/jupyterlab-manager
    # Install casa
    /usr/local/bin/pip install --extra-index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casatools==6.3.0.48
    /usr/local/bin/pip install --extra-index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casatasks==6.3.0.48
    /usr/local/bin/pip install --extra-index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casashell==6.3.0.48
    # Casa measures data
    /usr/local/bin/pip install --extra-index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casadata==2021.8.23
    #
    # Plotms and Casaviewer use appimage which from within singularity need 
    # root privaliges to mount due to SUID issues, as a work around we extract
    # the images and modify the casa tasks to call the extracted images
    /usr/local/bin/pip install --extra-index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casaplotms==1.2.8
    cd /usr/local/lib/python3.6/dist-packages/casaplotms/__bin__
    ./casaplotms-x86_64.AppImage --appimage-extract
    rm casaplotms-x86_64.AppImage
    find squashfs-root -type d | xargs chmod 775
    cd ..
    sed -i -e 's/casaplotms-x86_64.AppImage/squashfs-root\/AppRun/' private/plotmstool.py
    #
    /usr/local/bin/pip install --extra-index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casaviewer==1.2.14
    cd /usr/local/lib/python3.6/dist-packages/casaviewer/__bin__
    ./casaviewer-x86_64.AppImage --appimage-extract
    rm casaviewer-x86_64.AppImage
    find squashfs-root -type d | xargs chmod 775
    cd ..
    sed -i -e 's/casaviewer-x86_64.AppImage/squashfs-root\/AppRun/' private/config.py
    #
    #########################################
    # carta
    #########################################
    #
    cd /usr/local
    CARTAVERSION=1.4
    wget https://github.com/CARTAvis/carta/releases/download/v${CARTAVERSION}/CARTA-v${CARTAVERSION}-remote.tgz
    apt-get install -y libnss3 libgdk-pixbuf2.0-0 libgtk-3-0 #libx11-xcb1 libxss1 libasound2
    tar zxf CARTA-v${CARTAVERSION}-remote.tgz
    #
    #########################################
    # Install CASACORE
    #########################################
    #
    CASACORE_VERSION=3.3.0
    apt-get install -y libboost-all-dev build-essential libpython3-dev python3-dev python3-numpy gfortran \
                       libsofa1-dev flex bison libbison-dev libatlas-base-dev liblapack-dev libcfitsio-dev \
                       wcslib-dev cmake libreadline-dev libncurses5-dev libgsl-dev libfftw3-dev libhdf5-dev 
    cd /usr/local
    wget https://github.com/casacore/casacore/archive/v${CASACORE_VERSION}.tar.gz
    tar xvf v${CASACORE_VERSION}.tar.gz
    mkdir casacore-${CASACORE_VERSION}/build
    cd casacore-${CASACORE_VERSION}/build
    cmake -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_BUILD_TYPE=Release -DBUILD_DEPRECATED=ON -DBUILD_PYTHON=OFF -DBUILD_PYTHON3=ON ../ 
    make -j4
    make install
    cd ../..
    rm -rf v${CASACORE_VERSION}.tar.gz casacore-${CASACORE_VERSION}
    #
    #########################################
    # Add Wsclean
    #########################################
    #
    apt-get install -y git
    cd /usr/local
    git clone https://github.com/lofar-astron/LOFARBeam.git
    cd LOFARBeam
    git checkout v4.1.1
    mkdir -p build
    cd build
    cmake -DPYTHON_EXECUTABLE=$(which python3) ..
    make -j4
    make install
    cd /usr/local
    rm -rf LOFARBeam
    git clone https://gitlab.com/aroffringa/wsclean.git wsclean-code
    cd wsclean-code
    git checkout v2.10.1
    mkdir build
    cd build
    cmake ..
    make -j4
    make install
    /usr/local/bin/pip install python-casacore
    cd /usr/local
    rm -rf wsclean-code
    #
    #########################################
    # Add AOFLAGGER
    #########################################
    #
    apt-get install -y libboost-test-dev libgtkmm-3.0-dev liblua5.3-dev libpng-dev libxml2-dev
    /usr/local/bin/pip install pytest
    git clone https://github.com/pybind/pybind11.git
    cd pybind11
    git checkout v2.6.0
    mkdir build
    cd build
    cmake -DDOWNLOAD_CATCH=1 ..
    make -j4
    make install
    cd ..
#   python setup.py install
    cd ..
    rm -rf pybind11
    git clone https://gitlab.com/aroffringa/aoflagger.git
    mkdir -p aoflagger/build
    cd aoflagger/build
    cmake ..
    make -j4
    make install
    cd ../..
    rm -rf aoflagger
    #
    #########################################
    # JIVE VLBI Tools
    #########################################
    #
    git clone https://github.com/jive-vlbi/casa-vlbi 
    cp casa-vlbi/*py /usr/local/bin 
    cp -r casa-vlbi/casavlbitools /usr/local/lib/python3.6/dist-packages 
    rm -rf casa-vlbi
    #
    #########################################
    # Plotcalng
    #########################################
    #
    git clone https://github.com/aardk/evn-tools
    cp -r evn-tools/python/evn_tools /usr/local/lib/python3.6/dist-packages
    rm -rf evn-tools
    /usr/local/bin/pip install pyvo
    #
    #########################################
    # Jupyter-casa
    #########################################
    #
    cd /usr/local
    mkdir -p /usr/local/lib/python3.6/dist-packages
    mv jupyter-casa/python/start_casa /usr/local/lib/python3.6/dist-packages/
    cp -r jupyter-casa/jupyter /usr/local/share/
    # Modified casa tasks for Jupyter
    cd /usr/local
    patch lib/python3.6/dist-packages/casatasks/private/task_setjy.py jupyter-casa/python/casa/task_setjy.patch
